<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- <link rel="stylesheet" href="style-portrait.css" /> -->
    <style lang="">
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 10px;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <!-- <table>
        <colgroup>
            <col style="width: 10%">
            <col style="width: 20%">
            <col style="width: 20%">
            <col style="width: 20%">
            <col style="width: 30%">
        </colgroup>
        <tr class="header">
            <th>NO.(R2)</th>
            <th>內容(R2)</th>
            <th>負責人員(R1)</th>
            <th>預計確認/<br>提供日(R2)</th>
            <th>回覆說明</th>
        </tr>
        <tr class="odd">
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
        </tr>
        <tr class="odd">
            <td>1</td>
            <td>1</td>
            <td>2</td>
            <td>122222222222222222222222222222222222222222222222222222222222222222222222222222123</td>
            <td>1</td>
        </tr>
    </table> -->
    <table>
        <thead>
            <tr class="header">
                <th>&gt;</th>
                <th>測試</th>
                <th>&lt;</th>
            </tr>
        </thead>
        <tbody>
            <tr class="odd">
                <td>A</td>
                <td>B</td>
                <td>E</td>
            </tr>
            <tr class="even">
                <td>^</td>
                <td>^</td>
                <td>^F</td>
            </tr>
            <tr class="odd">
                <td>^</td>
                <td>C</td>
                <td>G</td>
            </tr>
            <tr class="even">
                <td>^</td>
                <td>^</td>
                <td>^H</td>
            </tr>
            <tr class="odd">
                <td>^</td>
                <td>D</td>
                <td>Z</td>
            </tr>
            <tr class="even">
                <td>^</td>
                <td>^</td>
                <td>^X</td>
            </tr>
            <tr class="odd">
                <td>F</td>
                <td>&lt;</td>
                <td>&lt;</td>
            </tr>
        </tbody>
    </table>

    <script>
        function changeColGroup(table) {
            const tr = table.getElementsByTagName("tr")[0];
            const ths = tr.getElementsByTagName("th");
            let styleArr = [];
            let styleTotalNumber = 0;
            const addStyleArr = (number) => {
                styleArr.push(number);
                styleTotalNumber += number;
            };
            const regex = /\((R\d+)\)/;
            for (let i = 0; i < ths.length; i++) {
                const text = ths[i].innerHTML;
                const match = text.match(regex);
                if (match) {
                    const number = parseInt(match[1].substring(1));
                    const newText = text.replace(regex, "");
                    ths[i].innerHTML = newText;
                    addStyleArr(number);
                } else {
                    addStyleArr(1);
                }
            }
            const colWidthArr = styleArr.map(
                (number) => ((number / styleTotalNumber) * 100).toFixed(1) + "%"
            );
            const colgroup = table.getElementsByTagName("colgroup")[0];
            if (colgroup) {
                const cols = colgroup.getElementsByTagName("col");
                for (let j = 0; j < cols.length; j++) {
                    const col = cols[j];
                    const style = col.style;
                    style.width = colWidthArr[j];
                }
            }else{
                const colGroup = document.createElement("colgroup");
                for (let width of colWidthArr) {
                    const col = document.createElement("col");
                    col.style.width = width;
                    colGroup.appendChild(col);
                    table.appendChild(colGroup);
                }
            }

            
        }

        function processTable(table) {
            const head = table.tHead;
            const body = table.tBodies[0];
            if (head) {
                const parent = head.parentNode;
                while (head.rows.length > 0) {
                    parent.insertBefore(head.rows[0], head);
                }
                parent.removeChild(head);
            }

            if (body) {
                const parent = body.parentNode;
                while (body.rows.length > 0) {
                    parent.insertBefore(body.rows[0], body);
                }
                parent.removeChild(body);
            }

            for (let j = 0; j < table.rows.length; j++) {
                const row = table.rows[j];
                for (let k = 0; k < row.cells.length; k++) {
                    const cell = row.cells[k];
                    const content = cell.textContent.trim();

                    //往右合併
                    if (content === ">") {
                        cell.style.display = "none";
                        const nextIndex = (function findNextIndex(k) {
                            return row.cells[k + 1].textContent.trim() !== ">"
                                ? k + 1
                                : findPrevIndex(k + 1);
                        })(k);
                        row.cells[nextIndex].colSpan = row.cells[nextIndex].colSpan + 1;
                    }
                    //往左合併
                    if (content === "<") {
                        cell.style.display = "none";
                        const prevIndex = (function findPrevIndex(k) {
                            return row.cells[k - 1].textContent.trim() !== "<"
                                ? k - 1
                                : findPrevIndex(k - 1);
                        })(k);
                        row.cells[prevIndex].colSpan = row.cells[prevIndex].colSpan + 1;
                    }
                    // 往上合併

                    if (content.startsWith("^")) {
                        function findTrIndex(j) {
                            const cell = table.rows[j - 1]?.cells[k];
                            if (!cell.textContent.startsWith("^") && cell.style.display !== 'none') return j - 1
                            return findTrIndex(j - 1)
                        }
                        const index = findTrIndex(j);
                        const originRowSpan = table.rows[index]?.cells[k]?.rowSpan;
                        if (originRowSpan)
                            table.rows[index].cells[k].rowSpan = originRowSpan + 1;
                        const isAddBr = (table.rows[index].cells[k].innerHTML.length !== 0 && cell.textContent.replace(/\^/g, "").trim().length !== 0)
                        table.rows[index].cells[k].innerHTML += isAddBr ?
                            "</br>" + cell.textContent.replace(/\^/g, "") : cell.textContent.replace(/\^/g, "");
                        cell.style.display = "none";
                    }
                }
            }
        }

        const tables = document.getElementsByTagName("table");
        for (var i = 0; i < tables.length; i++) {
            processTable(tables[i]);
            changeColGroup(tables[i]);
        }
    </script>
</body>

</html>