# 教育訓練

sunny_twczw_webs -> 陽信商店街  
sunnyds -> 商圈

# [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#sunnygo-%E5%89%8D%E5%BE%8C%E7%AB%AF "sunnygo-前後端")sunnygo 前後端

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E5%BE%8C%E7%AB%AF%E5%BB%BA%E7%BD%AE%E7%92%B0%E5%A2%83 "後端建置環境")後端建置環境

虛擬環境下載

檢測虛擬環境是否裝好

```
wsl --set-default-version2 
```

![](https://i.imgur.com/O7ztuol.png)

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#0-%E5%BB%BA%E7%AB%8Btest%E8%B3%87%E6%96%99%E5%A4%BE "0-建立test資料夾")0. 建立test資料夾

docker_lnmp-master 放入項目 test

![](https://i.imgur.com/vvZc1o3.png)

將 sg_test\nginx\vhosts 的 test.conf 做更改WWW路徑**很重要!**  
![](https://i.imgur.com/Vi2g0v3.png)

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#1-%E7%92%B0%E5%A2%83%E8%B3%87%E6%96%99%E5%A4%BE%E9%96%8B%E5%95%9F%E7%B5%82%E7%AB%AF "1-環境資料夾開啟終端")1. 環境資料夾開啟終端

輸入:  
wsl -l -v  
docker-compose up -d (安裝環境、執行環境)

![](https://i.imgur.com/1CQOXz8.png)

安裝完成 開啟dosker 檢查test項目有在running

![](https://i.imgur.com/XAL7pyj.png)

網頁開啟 [http://localhost/index.php](http://localhost/index.php)

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#2-%E7%92%B0%E5%A2%83%E8%B3%87%E6%96%99%E5%A4%BE "2-環境資料夾")2. 環境資料夾

SG_WWW 放入項目 test/www/sunny

若是沒有composer update  
( Composer是PHP的軟體套件管理系統，它提供用於管理PHP軟體和依賴庫關係的標準格式，因此要在dosker執行命令)  
開啟dosker php Terminl  
輸入:

#### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#21-composer--v "21-composer--v")2.1. composer -v

#### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#22-pwd "22-pwd")2.2. pwd

#### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#23-%E9%80%B2%E5%85%A5%E5%88%B0-sunny-%E7%9B%AE%E9%8C%84%E5%BA%95%E4%B8%8Bcd-varwwwsunny "23-進入到-sunny-目錄底下cd-varwwwsunny")2.3. 進入到 sunny 目錄底下(cd /var/www/sunny)

![](https://i.imgur.com/Vd2L6nI.png)

#### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#24-%E5%8F%AF%E7%94%A8%E6%9B%B4%E6%94%B9%E7%B6%B2%E5%9D%80 "24-可用更改網址")2.4. 可用(更改網址):

1.  composer config -g repo.packagist composer [https://packagist.org](https://packagist.org/)
2.  composer update

網址錯誤 可到 \test\www\sunny 打開 composer.json 最底下加入

```





  "repositories": {
        "packagist": {
            "type": "composer",
            "url": "https://packagist.org"
        }
    }
```

composer update -vvv(會顯示細項)

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#3-%E8%A4%87%E8%A3%BD-envexample-%E6%94%B9%E5%90%8D%E7%A8%B1-env-%E6%89%93%E9%96%8B "3-複製-envexample-改名稱-env-打開")3. 複製 .env.example 改名稱 .env 打開

更改 host、username、password

![](https://i.imgur.com/x6Kn8bj.png)

![](https://i.imgur.com/ADv8Vjl.png)

```

# 數據庫連接
DB_CONNECTION=mysql
DB_HOST=210.65.117.80
DB_PORT=3306/13306
DB_DATABASE=sunny_twczw_webs
DB_USERNAME=root
DB_PASSWORD=sunnygo1234


REDIS_HOST=172.16.1.2
REDIS_PASSWORD=null
REDIS_PORT=6379
```

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E6%B8%AC%E8%A9%A6%E6%9C%8D%E8%B3%87%E6%96%99%E5%BA%AB "測試服資料庫")測試服資料庫

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#1-%E5%9C%A8docker-php-%E5%AE%89%E8%A3%9Dssh "1-在docker-php-安裝ssh")1. 在docker php 安裝ssh

```
apt-get install ssh
```

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#2-%E9%80%A3%E6%8E%A5%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E5%BA%AB "2-連接測試資料庫")2. 連接測試資料庫

```
ssh -o ServerAliveInterval=60 -N -L 13306:127.0.0.1:3306 openlife@210.65.117.80

// 密碼:lifeopen
```

網頁開啟 [http://localhost/get_ip](http://localhost/get_ip)

![](https://i.imgur.com/yFaxAis.png)

---

環境結束!

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E8%A3%9C%E5%85%85 "補充")補充

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#es-%E6%90%9C%E7%B4%A2%E6%96%87%E6%AA%94 "es-搜索文檔")es 搜索文檔

當有手動修改關鍵字分詞文檔(dic) 需要執行命令才會生效

```
php artisan es:init
```

分詞文檔(dic)  
ex:

```
筆電

芳香機
```

同意詞文黨 (要再自行建立檔案)

```
蘋果手機 , iphone 11 , iphone 13 (搜索時都會出現)

筆電 , 筆記型電腦 , mac 
```

熱門關鍵字 後台設定

crontab  
最短到分鐘，會定時呼叫程式執行  
supervisor(守護進程)  
分鐘以下，會在背景運作

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E6%97%A5%E8%AA%8C%E8%A8%98%E9%8C%84%E5%9C%A8-Storage "日誌記錄在-Storage")日誌記錄在 Storage

需輸入log關鍵字(Log::info(‘支付參數’)) || uuid  
home/openlife/www/storage/logs/apiweb# cat <請求時間> | grep <支付參數>

監聽: tail -f app.fpm-fcgi.20230301.log |grep ‘’

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E9%87%8D%E5%95%9F%E9%9A%8A%E5%88%97 "重啟隊列")重啟隊列

重啟露失敗的隊列會自動消失  
sudo -s  
php artisan queue:retry (uuid)

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E5%AE%9A%E6%99%82%E4%BB%BB%E5%8B%99 "定時任務")定時任務

app/console/kernel.php 檔案查看

### [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6 "nginx配置文件")nginx配置文件

一個配置文件對應一個項目  
sunny->自行命名

```
test\nginx\vhosts\test.conf
```

![](https://i.imgur.com/twhliDX.png)

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E5%BA%97%E5%95%86%E5%89%8D%E5%8F%B0 "店商前台")店商前台

[http://vcs.sunnygo.com.tw/SUNNYGO](http://vcs.sunnygo.com.tw/SUNNYGO)

package.json 在master裡面

```
git clone 
git checkout master
    
npm i


npm run dev
```

![](https://i.imgur.com/5HuuyXH.png)

![](https://i.imgur.com/Ex1Ec9g.png)

![](https://i.imgur.com/nbruthp.png)

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E5%BE%8C%E7%AB%AF%E5%AF%A6%E4%BD%9C "後端實作")後端實作

1.創建新的Http/GoodRecommend  
![](https://i.imgur.com/YHEMR6d.png)

![](https://i.imgur.com/MWiogsC.png)

3.創建新的Models/GoodRecommend  
![](https://i.imgur.com/s1FsaSD.png)

4.創建新的Requests/GoodRecommend  
![](https://i.imgur.com/b7RsG8i.png)

![](https://i.imgur.com/WP9RMEC.png)

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E5%AE%9A%E6%99%82%E4%BB%BB%E5%8B%991 "定時任務1")定時任務

有php可以在cmd執行，沒有就在docker php 執行

php artisan 固定命令

```
php artisan example command  

php artisan schedule:run
```

![](https://i.imgur.com/r6dnpQy.png)

![](https://i.imgur.com/DaMSNb1.png)

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E9%9A%8A%E5%88%97 "隊列")隊列

用途:簡訊、email、開電子發票…等  
類似evenloop  
排隊進行，再由框架來執行

```













 php artisan queue:work redis --queue=high   監聽隊列
 php artisan queue:retry   重啟隊列
 //重啟job 要確認資料是否已經有異動
 //1.每個job都可以重複執行
 //2.在確認執行成功後才能到資料庫
 //3.執行成功後再到資料庫
 //4.資料庫資料不能有執行一半的狀態

 //異步隊列
 ExampleJob::dispatch($time);
 //同步隊列
  ExampleJob::dispatchSync($time);
```

## [](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E9%9B%BB%E5%AD%90%E7%A5%A8%E5%88%B8 "電子票券")電子票券

orderPayCallBack->foreignTicketGetJob->foreignTicketSaveJob  
下訂單(已付款)->待出貨(票券未拿到)->已完成(有拿到票券)

票券有問題:  
人工補票券->重啟隊列  
沒補票券->取消訂單

已完成:  
票券加到該會員裡(資料庫 QRcode、連接…等)  
送點數

若是有增加新的廠商票券:  
修改(客製店家票券)  
foreignTicketGetJob,php  
foreignTicketSaveJob.php

票券作廢(RefoundService.php):  
向第三方廠商發出退票請求  
可退票(&&部分退票):  
系統處理，業務可自行在後台訂製退票金額

不可退票:  
系統拋出異常給前端(實際上需要聯若業務)

核銷:  
寫在每個票券廠商的api  
ex:  
LionService.php

router>->controller.php->service.php

資料庫:sunny_twczw_webs/yx_store_goods_virtual

ps:目前電子票券是由廠商提供api，串接後(定期拉取商品)可在後台自行上架票券

點數加減點結算(iParking)

PointService.php

-   [教育訓練](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#%E6%95%99%E8%82%B2%E8%A8%93%E7%B7%B4 "教育訓練")
-   [sunnygo 前後端](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#sunnygo-%E5%89%8D%E5%BE%8C%E7%AB%AF "sunnygo 前後端")

[全部展開](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#)[回到頂部](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#)[移至底部](https://hackmd.io/0IsKKfI4QKmfn4Ij98e5hQ?view#)

選擇 Repo